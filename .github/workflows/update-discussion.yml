name: Check CodeBundle Discussions
on:  
  workflow_dispatch:
  push:
jobs:
  check-discussions-on-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2


      - name: Check for CodeBundles
        id: find_codebundles
        run: |
          codebundles=$(find codebundles -type d -exec basename {} \; | grep -v "codebundles")
          echo "::set-output name=codebundles::$codebundles"
          echo $codebundles

      - name: Search Discussions
        id: search_discussions
        run: |
          codebundles=(${{ steps.find_codebundles.outputs.codebundles }})
          echo "Found codebundles: ${{ join(steps.find_codebundles.outputs.codebundles, ',') }}"
          echo "Searching discussions..."

          # Read the queries from separate files
          search_discussions_query=$(cat .github/queries/searchDiscussions.graphql | tr -d '\n' | sed 's/"/\\\"/g')
          create_discussion_query=$(cat .github/queries/createDiscussion.graphql | tr -d '\n' | sed 's/"/\\\"/g')
          add_comment_query=$(cat .github/queries/addDiscussionComment.graphql | tr -d '\n' | sed 's/"/\\\"/g')
          get_comments_query=$(cat .github/queries/graphql-queries/getComments.graphql | tr -d '\n' | sed 's/"/\\\"/g')

          # Perform the searchDiscussions query
          search_response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" -X POST -d "{\"query\": \"$search_discussions_query\", \"variables\": $search_discussions_variables}" https://api.github.com/graphql)
          discussion_nodes=$(echo "$search_response" | jq -r '.data.search.edges[].node.discussions.nodes[] | select(.title != null) | { id, title }')

          # Loop through the discussion nodes
          for discussion_node in $discussion_nodes; do
            codebundle=$(echo "$discussion_node" | jq -r '.title')
            discussion_id=$(echo "$discussion_node" | jq -r '.id')

            if [[ -z $discussion_id ]]; then
              echo "Creating new discussion for $codebundle"
              curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" -X POST -d "{\"query\": \"$create_discussion_query\", \"variables\": {\"repo_id\": \"$repo_id\", \"codebundle\": \"$codebundle\"}}" https://api.github.com/graphql > /dev/null
            else
              echo "Discussion found for $codebundle with ID: $discussion_id"

              # # Fetch comments for the discussion
              # comments_response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" -X POST -d "{\"query\": \"$get_comments_query\", \"variables\": {\"discussion_id\": \"$discussion_id\"}}" https://api.github.com/graphql)
              # notes=$(echo "$comments_response" | jq -r '.data.node.comments.edges[].node.body')

              # if [[ -z $notes ]]; then
              #   echo "Adding note to discussion for $codebundle"
              #   curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" -X POST -d "{\"query\": \"$add_comment_query\", \"variables\": {\"discussion_id\": \"$discussion_id\"}}" https://api.github.com/graphql > /dev/null
              # fi
            fi
          done

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
