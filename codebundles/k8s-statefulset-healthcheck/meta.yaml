commands:
- command: 'kubectl get events --context ${CONTEXT} -n ${NAMESPACE} -o json | jq ''(now
    - (60*60)) as $time_limit | [ .items[] | select(.type == "Warning" and (.involvedObject.kind
    == "StatefulSet" or .involvedObject.kind == "Pod") and (.involvedObject.name |
    tostring | contains("${STATEFULSET_NAME}")) and (.lastTimestamp | fromdateiso8601)
    >= $time_limit) | {kind: .involvedObject.kind, name: .involvedObject.name, reason:
    .reason, message: .message, firstTimestamp: .firstTimestamp, lastTimestamp: .lastTimestamp}
    ] | group_by([.kind, .name]) | map({kind: .[0].kind, name: .[0].name, count: length,
    reasons: map(.reason) | unique, messages: map(.message) | unique, firstTimestamp:
    map(.firstTimestamp | fromdateiso8601) | sort | .[0] | todateiso8601, lastTimestamp:
    map(.lastTimestamp | fromdateiso8601) | sort | reverse | .[0] | todateiso8601})'''
  doc_links: '

    - [Kubectl Get guide](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get){:target="_blank"}

    - [Context CLI Overview](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/#context){:target="_blank"}

    - [JSON Path Syntax](https://goessner.net/articles/JsonPath/){:target="_blank"}

    - [jq Manual](https://stedolan.github.io/jq/manual/){:target="_blank"}'
  explanation: '


    This command is used in Kubernetes to get all the events for a specific context,
    namespace and statefulset name that are warnings within the last hour. Specifically,
    it will print out information about the kind of object (like Pod or StatefulSet),
    the name of the object, how many events there are, the different reasons for the
    warnings, the associated messages, and the first and last timestamp for when the
    warnings occurred.'
  multi_line_details: "\n\n# This multi-line command checks for events of type \"\
    Warning\", that have occurred in the last hour for any StatefulSet or Pod with\
    \ a name containing the STATEFULSET_NAME, and converts this data into a JSON array\
    \ of the involvedObjects, containing counts, reasons, messages, firstTimestamps\
    \ and lastTimestamps of the events. \n\nkubectl get events \\\n    --context ${CONTEXT}\
    \ \\\n    -n ${NAMESPACE} \\\n    -o json | \n    jq '(now - (60*60)) as $time_limit\
    \ |             # Set a time limit of one hour ago\n       [ .items[] |      \
    \                            # For items in this list... \n            select(.type\
    \ == \"Warning\" and            # Select those with type \"Warning\" and\n   \
    \             (.involvedObject.kind == \"StatefulSet\" or .involvedObject.kind\
    \ == \"Pod\") and                        # involvedObjects which are of kind \"\
    StatefulSet\" or \"Pod\" and\n                (.involvedObject.name | tostring\
    \ | contains(\"${STATEFULSET_NAME}\")) and        # have names containing a certain\
    \ value \n                (.lastTimestamp | fromdateiso8601) >= $time_limit) |\
    \                         # which occurred after our set time limit\n       {kind:\
    \ .involvedObject.kind,                  # Output the result as an object\n  \
    \      name: .involvedObject.name, \n        reason: .reason, \n        message:\
    \ .message, \n        firstTimestamp: .firstTimestamp, \n        lastTimestamp:\
    \ .lastTimestamp} ] |            # ...and store it in an array\n     group_by([.kind,\
    \ .name]) |                      # Group by kind and name\n     map({        \
    \                                   # Map values\n         kind: .[0].kind, \n\
    \         name: .[0].name, \n         count: length, \n         reasons: map(.reason)\
    \ | unique, \n         messages: map(.message) | unique, \n         firstTimestamp:\
    \ map(.firstTimestamp | fromdateiso8601) | sort | .[0] | todateiso8601, \n   \
    \      lastTimestamp: map(.lastTimestamp | fromdateiso8601) | sort | reverse |\
    \ .[0] | todateiso8601})'"
  name: troubleshoot_statefulset_warning_events_for_statefulset_name
- command: 'kubectl get events --context ${CONTEXT} -n ${NAMESPACE} -o json | jq ''(now
    - (60*60)) as $time_limit | [ .items[] | select(.type != "Warning" and (.involvedObject.kind
    == "StatefulSet" or .involvedObject.kind == "Pod") and (.involvedObject.name |
    tostring | contains("${STATEFULSET_NAME}"))) | {kind: .involvedObject.kind, count:
    .count, name: .involvedObject.name, reason: .reason, message: .message, firstTimestamp:
    .firstTimestamp, lastTimestamp: .lastTimestamp, duration: (if (((.lastTimestamp
    | fromdateiso8601) - (.firstTimestamp | fromdateiso8601)) == 0) then 1 else (((.lastTimestamp
    | fromdateiso8601) - (.firstTimestamp | fromdateiso8601))/60) end) } ] | group_by([.kind,
    .name]) | map({kind: .[0].kind, name: .[0].name, count: (map(.count) | add), reasons:
    map(.reason) | unique, messages: map(.message) | unique, average_events_per_minute:
    (if .[0].duration == 1 then 1 else ((map(.count) | add)/.[0].duration ) end),firstTimestamp:
    map(.firstTimestamp | fromdateiso8601) | sort | .[0] | todateiso8601, lastTimestamp:
    map(.lastTimestamp | fromdateiso8601) | sort | reverse | .[0] | todateiso8601})'''
  doc_links: '

    - [Kubectl documentation](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands){:target="_blank"}

    - [StatefulSets reference](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/){:target="_blank"}

    - [Pod commands](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get-pods){:target="_blank"}

    - [JSONPath expressions](https://kubernetes.io/docs/reference/kubectl/jsonpath/){:target="_blank"}

    - [JQ examples](https://stedolan.github.io/jq/tutorial/){:target="_blank"}'
  explanation: '


    This command uses the kubectl tool to get events from a specific namespace within
    the Kubernetes cluster for a specified context. The events are in json format
    and are then passed to jq, which is used to process the events to provide a summary
    of the data. The summary includes the event kind, count, name, reasons, messages,
    average events per minute, first timestamp, and last timestamp. This information
    can help an engineer investigate issues within the cluster related to StatefulSets
    and Pods with the specified name.'
  multi_line_details: "\n\n# This command retrieves events from a Kubernetes cluster,\
    \ given some conditionals. It then groups the output and provides summary data,\
    \ such as counts, first and last timestamps, and average number of events per\
    \ minute. \n\n# Below is a multi-line version of the command\nkubectl get events\
    \ \\ \n    --context ${CONTEXT} \\ # Context defines which part of the cluster\
    \ to act on, such as a namespace or node.\n    -n ${NAMESPACE} \\ # Namespace\
    \ defines context for resource objects that have namespaces in the cluster.\n\
    \    -o json | jq '(now - (60*60)) as $time_limit | \n        [ .items[] | select(.type\
    \ != \"Warning\" and \n            (.involvedObject.kind == \"StatefulSet\" or\
    \ .involvedObject.kind == \"Pod\") and \n            (.involvedObject.name | tostring\
    \ | contains(\"${STATEFULSET_NAME}\"))) | \n            {kind: .involvedObject.kind,\
    \ count: .count, name: .involvedObject.name, reason: .reason, message: .message,\
    \ \n            firstTimestamp: .firstTimestamp, lastTimestamp: .lastTimestamp,\n\
    \            duration: (if (((.lastTimestamp | fromdateiso8601) - (.firstTimestamp\
    \ | fromdateiso8601)) == 0) then 1 else (((.lastTimestamp | fromdateiso8601) -\
    \ (.firstTimestamp | fromdateiso8601))/60) end) } ] | \n        group_by([.kind,\
    \ .name]) | \n        map({kind: .[0].kind, name: .[0].name, count: (map(.count)\
    \ | add), reasons: map(.reason) | unique, messages: map(.message) | unique, \n\
    \            average_events_per_minute: (if .[0].duration == 1 then 1 else ((map(.count)\
    \ | add)/.[0].duration ) end),\n            firstTimestamp: map(.firstTimestamp\
    \ | fromdateiso8601) | sort | .[0] | todateiso8601, \n            lastTimestamp:\
    \ map(.lastTimestamp | fromdateiso8601) | sort | reverse | .[0] | todateiso8601})'\
    \ # The output is provided in JSON format."
  name: check_statefulset_event_anomalies_for_statefulset_name
- command: kubectl logs --tail=100 statefulset/${STATEFULSET_NAME} --context ${CONTEXT}
    -n ${NAMESPACE}
  doc_links: '

    - [Kubernetes Documentation for kubectl logs](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#logs){:target="_blank"}

    - [Kubernetes Documentation for StatefulSets](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/){:target="_blank"}

    - [Kubernetes Documentation for Contexts](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/){:target="_blank"}

    - [Kubernetes Documentation for Namespaces](https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/){:target="_blank"}'
  explanation: '


    This command allows you to view the logs of a particular stateful set in a Kubernetes
    cluster. The ''statefulset'' command identifies which stateful set whose logs
    we''re viewing, and ''tail=100'' means that we will only view the last 100 lines
    of logs. ''context'' specifies which context we want to view within the cluster,
    and ''namespace'' specifies which namespace we''ll look at. By providing this
    information, we can view the most recent log entries for the specified stateful
    set.'
  multi_line_details: "\n\n# Command to examine logs of a StatefulSet named ${STATEFULSET_NAME}\
    \ in namespace ${NAMESPACE} with Kubernetes context set to ${CONTEXT}.   \n# This\
    \ will display the last 100 lines of the log output.\nkubectl \\\n  logs \\  \
    \ # Invoking Kubernetes CLI command `logs`\n  --tail=100 \\   # Limiting line\
    \ output from the logs to the last 100\n  statefulset/${STATEFULSET_NAME} \\ \
    \ # Targeting the specified StatefulSet by name\n  --context ${CONTEXT} \\  #\
    \ Setting the context value (e.g., acme-cluster)\n  -n ${NAMESPACE}  # Setting\
    \ the namespace value (e.g., AcmeCorpInc)"
  name: fetch_statefulset_statefulset_name_logs
- command: kubectl get events --field-selector type=Warning --context ${CONTEXT} -n
    ${NAMESPACE} | grep -i "${STATEFULSET_NAME}" || true
  doc_links: '

    - [Kubectl Documentation](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands){:target="_blank"}

    - [Get Events Documentation](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get-events){:target="_blank"}

    - [Field Selectors Documentation](https://kubernetes.io/docs/concepts/overview/working-with-objects/field-selectors/){:target="_blank"}

    - [Context Concept Documentation](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/){:target="_blank"}

    - [Grep Utility Manual](https://www.gnu.org/software/grep/manual/grep.html){:target="_blank"}'
  explanation: '


    This command is used to view Kubernetes events that have the type of ''Warning''
    in the specific context and namespace provided. It will then filter the results
    to include only those related to a named StatefulSet. The "|| true" at the end
    ensures that the command does not fail if there are no matching results returned.'
  multi_line_details: " \n# Retrieve any events in the Kubernetes cluster based on\
    \ a specified context and namespace that have a type of warning \n# Context, namespace\
    \ and stateful set name are passed into the command as environment variables \n\
    kubectl \\\n    # Begin 'kubectl' command to interact with the Kubernetes API\n\
    \    get \\\n    # Command to retrieve resources\n    events \\\n    # Resource\
    \ to retrieve\n    --field-selector type=Warning \\\n    # Specify the type of\
    \ events we want to retrieve should be warning\n    --context ${CONTEXT} \\\n\
    \    # Specify the context of which the Kubernetes cluster this command is intended\
    \ for. Passsed in as an environment variable \n    -n ${NAMESPACE} \\\n    # Specify\
    \ the namespace within the Kubernetes cluster that the command will be running\
    \ in. Passed in as an environment variable\n    | \\\n    # Use a pipe to get\
    \ the input of one command (kubectl) as the output for another (grep)\n    grep\
    \ \\\n    # Command to search through text\n    -i \"${STATEFULSET_NAME}\" \\\n\
    \    # Search the returned event messages for occurrences of the specifed stateful\
    \ set name. Passed in as an environment variable\n    || true\n    # Execute the\
    \ command with a non-zero exit code regardless of the result. This is helpful\
    \ when nested commands are being used (e.g., 0 exit code prevents further logic\
    \ in the multi-line command from being excuted"
  name: get_related_statefulset_statefulset_name_events
- command: kubectl get statefulset ${LABELS} --context=${CONTEXT} -n ${NAMESPACE}
    -o yaml
  doc_links: '

    - [Kubernetes docs - how to use kubectl in the command line](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands){:target="_blank"}

    - [Kubernetes docs - StatefulSets concepts and usage](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#why-use-a-statefulset){:target="_blank"}'
  explanation: '


    This command is used to get information about a StatefulSet object in Kubernetes.
    A StatefulSet is used to manage the deployment and scaling of stateful applications.
    The command uses several options to specify which StatefulSet should be viewed:
    labels (for labeling resources for easy searching), context (to select the cluster
    to query info from), and namespace (to specify the Namespace/Project the StatefulSet
    lives in). It also includes an -o option to output in YAML format, which will
    return all the details associated with the selected StatefulSet.'
  multi_line_details: "\n# This command allows you to retrieve a YAML representation\
    \ of a given statefulset, which is part of a Kubernetes resource for deploying\
    \ and managing containers that can persist data.\n# The multi-line command looks\
    \ like this:\nkubectl \\\n    # Run the kubectl command \n    get \\\n    # Retrieve\
    \ a given resource\n    statefulset \\\n    # Specify the type of resource to\
    \ be retrieved \n    ${LABELS} \\\n    # Use provided labels to identify the resource\n\
    \    --context=${CONTEXT} \\\n    # Command should use the specified context \n\
    \    -n ${NAMESPACE} \\\n    # Target the provided namespace\n    -o yaml \n \
    \   # Represent information in a YAML format"
  name: fetch_statefulset_statefulset_name_manifest_details
- command: 'kubectl get statefulset -n ${NAMESPACE} -o json --context ${CONTEXT} |
    jq -r ''.items[] | select(.status.availableReplicas < .status.replicas) | "---\nStatefulSet
    Name: " + (.metadata.name|tostring) + "\nDesired Replicas: " + (.status.replicas|tostring)
    + "\nAvailable Replicas: " + (.status.availableReplicas|tostring)'''
  doc_links: '

    - [What is a StatefulSet?](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/){:target="_blank"}

    - [Managing Resources Using the JSONPath Expression Syntax](https://kubernetes.io/docs/reference/kubectl/jsonpath/){:target="_blank"}

    - [jq Manual](https://stedolan.github.io/jq/manual/){:target="_blank"}'
  explanation: "\n\nThis command will retrieve the information about a StatefulSet\
    \ in the Kubernetes cluster, which is a way of managing resources as a unit for\
    \ persistent applications. \nIt looks at the context and namespace associated\
    \ with it and returns the StatefulSet name, desired replicas, and available replicas.\
    \ \nThis helps you see the overall health status of the persistent application\
    \ and how close it is to achieving the desired state."
  multi_line_details: "\n\n# This command will pull a list of statefulsets within\
    \ a specific namespace and context, format the data using jq to output name, desired\
    \ replicas, \n# and currently available replicas of statefulsets with less replicas\
    \ than desired configed\n\n# Notice that variables such as NAMESPACE and CONTEXT\
    \ must be properly set before this cmd is run\nNAMESPACE=<INSERT_PROPER_NAMESPACE_HERE>\n\
    CONTEXT=<INSERT_PROPER_CONTEXT_HERE>\n\n# Now we can execute the command on multiple\
    \ lines\nkubectl get statefulset -n ${NAMESPACE} \\\n--context ${CONTEXT} \\\n\
    -o json \\\n| jq -r '.items[] | select(.status.availableReplicas < .status.replicas)\
    \ | \"---\\nStatefulSet Name: \" + (.metadata.name|tostring) + \"\\nDesired Replicas:\
    \ \" + (.status.replicas|tostring) + \"\\nAvailable Replicas: \" + (.status.availableReplicas|tostring)'"
  name: list_statefulsets_with_unhealthy_replica_counts_in_namespace_namespace
